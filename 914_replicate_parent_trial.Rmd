#Baseline characteristics (log-transform -> ANOVA)
```{r}
library(tidyverse)
library(tableone)
library(flextable)
library(officer)
library(broom)

# ---- 1. Read and Clean Data ----
data <- read_csv(paste0(data_PATH, "914_complete_data_wide.csv"))

treat_var <- "Treatment"   # Ensure this matches your column name

data2 <- data %>%
  mutate(
    .treat = as.factor(.data[[treat_var]]),
    
    AN_Subtype = factor(AN_Subtype, levels = c(1, 2),
                        labels = c("Restricting", "Binge–purge")),
    Depression = factor(Depression, levels = c(0, 1), labels = c("No", "Yes")),
    Anxiety = factor(Anxiety, levels = c(0, 1), labels = c("No", "Yes")),
    `Ever_taken_psych_meds?` = factor(`Ever_taken_psych_meds?`,
                                      levels = c(0, 1), labels = c("No", "Yes")),
    Regular_Periods = factor(Regular_Periods, levels = c(0, 1),
                             labels = c("No", "Yes")),
    Estrogen_Deplete_or_Replete = factor(
      Estrogen_Deplete_or_Replete,
      levels = c(0, 1),
      labels = c("Deplete", "Replete")
    ),
    OCP_Use = factor(OCP_Use, levels = c(0, 1), labels = c("No", "Yes"))
  )

# ---- 2. Define Variables ----
vars <- c("Age", "BL_Weight", "BL_BMI", "Length_of_Diagnosis", "AN_Subtype", 
          "Depression", "Anxiety", "Ever_taken_psych_meds?", "Regular_Periods", 
          "Estrogen_Deplete_or_Replete", "OCP_Use", "BL_Total_T", "BL_Free_T", 
          "BL_EDE_Q_Subscore_Global_Score")

factorVars <- c("AN_Subtype", "Depression", "Anxiety", "Ever_taken_psych_meds?", 
                "Regular_Periods", "Estrogen_Deplete_or_Replete", "OCP_Use")

# Identify Continuous Variables (vars that are NOT factors)
contVars <- setdiff(vars, factorVars)

labels <- c(
  Age = "Age, years",
  BL_Weight = "Weight, kg",
  BL_BMI = "Body mass index, kg/m²",
  Length_of_Diagnosis = "Duration of anorexia nervosa, years",
  AN_Subtype = "AN subtype",
  Depression = "Major depressive disorder",
  Anxiety = "Generalized anxiety disorder",
  `Ever_taken_psych_meds?` = "Psychiatric medication use",
  Regular_Periods = "Current amenorrhea",
  Estrogen_Deplete_or_Replete = "Estrogen status",
  OCP_Use = "Combination oral contraceptive use",
  BL_Total_T = "Total testosterone, ng/dL",
  BL_Free_T = "Free testosterone, ng/dL",
  BL_EDE_Q_Subscore_Global_Score = "EDE-Q global score"
)

# ---- 3. Generate Raw Table Values (Mean/SD) ----
# tableone to calculate the raw numbers, turn off p-values
t1 <- CreateTableOne(
  vars = vars,
  strata = ".treat",
  data = data2,
  factorVars = factorVars,
  includeNA = FALSE,
  addOverall = TRUE,
  test = FALSE # added later from separate calcs below
)

# Extract the data frame
t1_df <- print(t1, quote = FALSE, noSpaces = TRUE, printToggle = FALSE) %>%
  as.data.frame() %>%
  rownames_to_column(var = "rowname")

# ---- 4. Calculate P-Values ----

# A. Continuous Variables: Log-transformed ANOVA
p_values_cont <- map_dfr(contVars, function(v) {
  
  clean_df <- data2 %>%
    select(val = all_of(v), grp = .treat) %>%
    drop_na()
  
  # Log transform
  clean_df$log_val <- log(clean_df$val)
  
  # ANOVA
  fit <- aov(log_val ~ grp, data = clean_df)
  p_val <- tidy(fit) %>% filter(term == "grp") %>% pull(p.value)
  
  # Return row with P-value converted to char to match tableone output
  tibble(rowname = v, p = as.character(p_val))
})

# B. Categorical Variables: Standard Tests (Fisher/Chi-sq)
t1_cat <- CreateTableOne(vars = factorVars, strata = ".treat", data = data2, factorVars = factorVars, test = TRUE)

# Extract and ensure p column is char
p_values_cat <- print(t1_cat, printToggle = FALSE, quote = FALSE) %>%
  as.data.frame() %>%
  rownames_to_column("rowname") %>%
  select(rowname, p) %>%
  filter(p != "") %>%
  mutate(p = as.character(p)) 

# C. Combine p-values
p_values_all <- bind_rows(p_values_cont, p_values_cat) %>%
  mutate(p_formatted = case_when(
    is.na(p) ~ "",
    # If it's already a formatted string like "<0.001" from tableone, keep it
    str_detect(p, "<") ~ p,
    # If it's a number (as string), format it
    as.numeric(p) < 0.001 ~ "<.001",
    TRUE ~ format(round(as.numeric(p), 3), nsmall = 3)
  ))
# ---- 5. Merge and Format ----

final_df <- t1_df %>%
  # Join custom p-values. 
  left_join(p_values_all %>% select(rowname, p_formatted), by = "rowname") %>%
  mutate(
    # Use the labels mapping
    Characteristic = recode(rowname, !!!labels),
    # Fill in labels that didn't match (categorical levels)
    Characteristic = ifelse(is.na(Characteristic), rowname, Characteristic),
    # If the join found a p-value, use it. Otherwise leave blank.
    p = replace_na(p_formatted, "")
  ) %>%
  select(Characteristic, everything(), -rowname, -p_formatted)

# ---- 6. Export to Word ----

ft <- flextable(final_df) %>%
  autofit() %>%
  bold(part = "header") %>%
  fontsize(size = 10, part = "all") %>%
  align(align = "left", part = "all") %>%
  set_caption(
    caption = "Table 1. Baseline clinical characteristics (Mean ± SD, but P-values via Log-ANOVA)",
    autonum = officer::run_autonum(seq_id = "tab", bkm = "table1")
  ) %>%
  add_footer_lines("Note: Continuous variables compared using ANOVA after log-transformation. Categorical variables compared using Fisher's exact or Chi-square tests.")

doc <- read_docx() %>%
  body_add_flextable(ft)

print(doc, target = "Table1_Hybrid_Log_Analysis.docx")
```

#BL-4 week ANCOVA 
```{r}
library(tidyverse)
library(emmeans)
library(flextable)
library(officer)
library(broom)

# ---- 1. Read Data ----
data_ancova <- read_csv(paste0(data_PATH, "914_complete_data.csv"))

# ---- 2. Prepare Data ----
# Ensure Treatment is a factor
data_ancova <- data_ancova %>%
  mutate(
    Treatment_Factor = factor(Treatment, levels = c(0, 1), labels = c("Placebo", "Testosterone"))
  )

# Define the pairs (Label = c(Pre_Column, Post_Column))
ancova_vars <- list(
  "BMI (kg/m²)" = c(pre = "BL_BMI", post = "WK4_BMI"),
  "Depression (HAM-D 17)" = c(pre = "BL_Total_HAM_D_17_Score", post = "WK4_Total_HAM_D_17_Score"),
  "Anxiety (HAM-A 14)" = c(pre = "BL_Total_HAM_A_14_Score", post = "WK4_Total_HAM_A_14_Score")
)

# ---- 3. Run ANCOVA Loop w/ dynamic formula----
results_list <- list()

for (label in names(ancova_vars)) {
  
  # Get variable names
  pre_var  <- ancova_vars[[label]]["pre"]
  post_var <- ancova_vars[[label]]["post"]
  
  # 1. Clean Data
  # FIX: Use unname() to strip the 'pre'/'post' labels so drop_na doesn't try to rename
  cols_to_check <- unname(c(pre_var, post_var, "Treatment_Factor"))
  
  model_data <- data_ancova %>%
    drop_na(all_of(cols_to_check))
  
  # 2. Construct Formula Dynamically
  f <- as.formula(paste(post_var, "~", pre_var, "+ Treatment_Factor"))
  
  # 3. Run Linear Model
  model <- lm(f, data = model_data)
  
  # 4. Extract P-value for Treatment
  p_val <- tidy(model) %>% 
    filter(str_detect(term, "Treatment_Factor")) %>% 
    pull(p.value)
  
  # 5. Calculate Adjusted Means (Least Squares)
  emm <- emmeans(model, ~ Treatment_Factor)
  emm_df <- as.data.frame(emm)
  
  # Extract values
  mean_placebo <- emm_df %>% filter(Treatment_Factor == "Placebo") %>% pull(emmean)
  mean_testosterone <- emm_df %>% filter(Treatment_Factor == "Testosterone") %>% pull(emmean)
  
  # 6. Store Result
  results_list[[label]] <- tibble(
    Outcome = label,
    `Placebo (Adj. Mean)` = mean_placebo,
    `Testosterone (Adj. Mean)` = mean_testosterone,
    `P-value` = p_val
  )
}

# Combine results
final_ancova <- bind_rows(results_list)

# ---- 4. Format and Export ----
final_ancova_fmt <- final_ancova %>%
  mutate(
    `Placebo (Adj. Mean)` = format(round(`Placebo (Adj. Mean)`, 1), nsmall = 1),
    `Testosterone (Adj. Mean)` = format(round(`Testosterone (Adj. Mean)`, 1), nsmall = 1),
    `P-value` = case_when(
      `P-value` < 0.001 ~ "<.001",
      TRUE ~ format(round(`P-value`, 3), nsmall = 3)
    )
  )

ft_ancova <- flextable(final_ancova_fmt) %>%
  autofit() %>%
  bold(part = "header") %>%
  fontsize(size = 10, part = "all") %>%
  set_caption(
    caption = "Table 3. Analysis of Covariance (ANCOVA) at 4 Weeks",
    autonum = officer::run_autonum(seq_id = "tab", bkm = "table3")
  ) %>%
  add_footer_lines("Note: Values represent Least Squares Means adjusted for baseline values.")

doc <- read_docx() %>%
  body_add_flextable(ft_ancova)

print(doc, target = "Table3_ANCOVA_Results.docx")
```
#BL-24 week LME 
```{r}
library(tidyverse)
library(lme4)
library(lmerTest) 
library(flextable)
library(officer)
library(broom.mixed)

# ---- 1. Read Data ----
data_lmm <- read_csv(paste0(data_PATH, "914_complete_data.csv"))

# Ensure Treatment and Subject are factors
data_lmm <- data_lmm %>%
  mutate(
    Treatment_Factor = factor(Treatment, levels = c(0, 1), labels = c("Placebo", "Testosterone")),
    Subject = as.factor(Subject) 
  )

# ---- 2. Define Variable Sequences (Weeks 4, 12, 18, 24) ----
variable_sequences <- list(
  "BMI" = c("BL_BMI", "WK4_BMI", "WK12_BMI", "WK18_BMI", "WK24_BMI"),
  
  "Depression (HAM-D)" = c("BL_Total_HAM_D_17_Score", "WK4_Total_HAM_D_17_Score", 
                           "WK12_Total_HAM_D_17_Score", "WK18_Total_HAM_D_17_Score", 
                           "WK24_Total_HAM_D_17_Score"),
  
  "Anxiety (HAM-A)" = c("BL_Total_HAM_A_14_Score", "WK4_Total_HAM_A_14_Score", 
                        "WK12_Total_HAM_A_14_Score", "WK18_Total_HAM_A_14_Score", 
                        "WK24_Total_HAM_A_14_Score")
)

# ---- 3. LME Helper Function ----
run_lmm_analysis <- function(data, col_names, outcome_label) {
  
  # A. Pivot Long
  long_df <- data %>%
    select(Subject, Treatment_Factor, all_of(col_names)) %>%
    pivot_longer(cols = all_of(col_names), names_to = "Time_Label", values_to = "Value") %>%
    mutate(
      Time = case_when(
        str_detect(Time_Label, "BL") ~ 0,
        str_detect(Time_Label, "WK4") ~ 4,
        str_detect(Time_Label, "WK12") ~ 12,
        str_detect(Time_Label, "WK18") ~ 18,
        str_detect(Time_Label, "WK24") ~ 24,
        TRUE ~ NA_real_
      )
    ) %>%
    drop_na(Value, Time)
  
  # B. Run Model with Fallback Logic
  
  result <- tryCatch({
    # ATTEMPT 1: Random Slope (Original Method) + Better Optimize (bobyqa)
    model <- lmer(Value ~ Time * Treatment_Factor + (1 + Time | Subject), 
                  data = long_df,
                  control = lmerControl(optimizer = "bobyqa"))
    
    # Check for Singularity 
    if (isSingular(model)) warning("Singular fit")
    
    list(model = model, type = "Random Slope (Original)")
    
  }, warning = function(w) {
    # If Attempt 1 warns (convergence issue), trigger Attempt 2
    return(NULL)
  }, error = function(e) {
    # If Attempt 1 errors, trigger Attempt 2
    return(NULL)
  })
  
  # ATTEMPT 2: Fallback to Random Intercept Only
  # If Attempt 1 failed (returned NULL), run the simpler model
  if (is.null(result)) {
    message(paste("Note: Simplified model used for", outcome_label, "due to convergence warning."))
    model <- lmer(Value ~ Time * Treatment_Factor + (1 | Subject), data = long_df)
    result <- list(model = model, type = "Random Intercept (Simplified)")
  }
  
  # C. Extract Results
  res <- tidy(result$model) %>% filter(str_detect(term, ":")) # Interaction term
  
  return(tibble(
    Outcome = outcome_label,
    `Model Type` = result$type,
    `Slope Difference` = res$estimate,
    `P-value` = res$p.value
  ))
}

# ---- 4. Run Loop ----
lmm_results_list <- list()

for (lbl in names(variable_sequences)) {
  cols <- variable_sequences[[lbl]]
  # Check for missing columns
  missing <- cols[!cols %in% names(data_lmm)]
  
  if (length(missing) == 0) {
    lmm_results_list[[lbl]] <- run_lmm_analysis(data_lmm, cols, lbl)
  } else {
    warning(paste("Skipping", lbl, "- Missing:", paste(missing, collapse=", ")))
  }
}

final_lmm <- bind_rows(lmm_results_list)

# ---- 5. Format and Export ----
if (nrow(final_lmm) > 0) {
  
  final_lmm_fmt <- final_lmm %>%
    mutate(
      `Slope Difference` = format(round(`Slope Difference`, 3), nsmall = 3),
      `P-value` = case_when(
        is.na(`P-value`) ~ "Error",
        `P-value` < 0.001 ~ "<.001",
        TRUE ~ format(round(`P-value`, 3), nsmall = 3)
      )
    )
  
  ft_lmm <- flextable(final_lmm_fmt) %>%
    autofit() %>%
    bold(part = "header") %>%
    set_caption(
      caption = "Table 4. Longitudinal Analysis (Linear Mixed Model, 0-24 Weeks)",
      autonum = officer::run_autonum(seq_id = "tab", bkm = "table4")
    ) %>%
    add_footer_lines("Note: 'Random Slope' fits individual rates of change per subject. 'Random Intercept' assumes parallel individual baselines. P-value tests the Time*Treatment interaction.")
  
  doc <- read_docx() %>%
    body_add_flextable(ft_lmm)
  # FIX: Save specifically to your data_PATH
  output_file <- paste0(data_PATH, "Table4_LMM_Results_Robust.docx")
  print(doc, target = output_file)
} else {
  stop("NO RESULTS GENERATED.")
}
```
