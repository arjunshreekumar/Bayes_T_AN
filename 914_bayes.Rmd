#Data, paths 
```{r}
PATH <- "/Users/arjun/Desktop/914/"
data_PATH <- paste0(PATH, 'data/')
results_PATH <- paste0(PATH, 'results/')

joined_data <- read.csv(paste0(data_PATH, "914_complete_data.csv"))
```

#Basline characteristics 
```{r}
library(tidyverse)
library(tableone)
library(flextable)
library(officer)

data <- read_csv(paste0(data_PATH, "914_complete_data_wide.csv"))
treat_var <- "Treatment"   # e.g., "arm", "group", "tx"

# ---- recode variables ----
data2 <- data %>%
  mutate(
    .treat = as.factor(.data[[treat_var]]),

    AN_Subtype = factor(AN_Subtype, levels = c(1, 2),
                        labels = c("Restricting", "Binge–purge")),
    Depression = factor(Depression, levels = c(0, 1), labels = c("No", "Yes")),
    Anxiety = factor(Anxiety, levels = c(0, 1), labels = c("No", "Yes")),
    `Ever_taken_psych_meds?` = factor(`Ever_taken_psych_meds?`,
                                      levels = c(0, 1), labels = c("No", "Yes")),
    Regular_Periods = factor(Regular_Periods, levels = c(0, 1),
                             labels = c("No", "Yes")),
    Estrogen_Deplete_or_Replete = factor(
      Estrogen_Deplete_or_Replete,
      levels = c(0, 1),
      labels = c("Deplete", "Replete")
    ),
    OCP_Use = factor(OCP_Use, levels = c(0, 1), labels = c("No", "Yes"))
  )

# ---- variables & labels ----
vars <- c(
  "Age",
  "BL_Weight",
  "BL_BMI",
  "Length_of_Diagnosis",
  "AN_Subtype",
  "Depression",
  "Anxiety",
  "Ever_taken_psych_meds?",
  "Regular_Periods",
  "Estrogen_Deplete_or_Replete",
  "OCP_Use",
  "BL_Total_T",
  "BL_Free_T",
  "BL_EDE_Q_Subscore_Global_Score"
)

factorVars <- c(
  "AN_Subtype",
  "Depression",
  "Anxiety",
  "Ever_taken_psych_meds?",
  "Regular_Periods",
  "Estrogen_Deplete_or_Replete",
  "OCP_Use"
)

labels <- c(
  Age = "Age, years",
  BL_Weight = "Weight, kg",
  BL_BMI = "Body mass index, kg/m²",
  Length_of_Diagnosis = "Duration of anorexia nervosa, years",
  AN_Subtype = "AN subtype",
  Depression = "Major depressive disorder",
  Anxiety = "Generalized anxiety disorder",
  `Ever_taken_psych_meds?` = "Psychiatric medication use",
  Regular_Periods = "Current amenorrhea",
  Estrogen_Deplete_or_Replete = "Estrogen status",
  OCP_Use = "Combination oral contraceptive use",
  BL_Total_T = "Total testosterone, ng/dL",
  BL_Free_T = "Free testosterone, ng/dL",
  BL_EDE_Q_Subscore_Global_Score = "EDE-Q global score"
)

# ---- create Table 1 ----
table1 <- CreateTableOne(
  vars = vars,
  strata = ".treat",
  data = data2,
  factorVars = factorVars,
  includeNA = FALSE,
  addOverall = TRUE
)

# ---- extract table and keep variable names ----
table1_df <- print(
  table1,
  quote = FALSE,
  noSpaces = TRUE,
  printToggle = FALSE
) %>%
  as.data.frame() %>%
  rownames_to_column(var = "Characteristic") %>%
  mutate(
    Characteristic = recode(Characteristic, !!!labels)
  )

# ---- build Word table ----
ft <- flextable(table1_df) %>%
  autofit() %>%
  bold(part = "header") %>%
  fontsize(size = 10, part = "all") %>%
  align(align = "left", part = "all") %>%
  set_caption(
    caption = "Table 1. Baseline clinical and hormonal characteristics by treatment group",
    autonum = officer::run_autonum(seq_id = "tab", bkm = "table1")
  )

# ---- export to Word ----
doc <- read_docx() %>%
  body_add_flextable(ft)

print(doc, target = "Table1_Baseline_Characteristics_914.docx")

```

#3 Factor Bayes helper function 
```{r}
options(mc.cores = 1)

suppressPackageStartupMessages({
  library(brms)
  library(dplyr)
  library(tidyr)
})

# ------------------------------------------------------------
# 3-Factor model helper (Treatment * Meal * Session)
# ------------------------------------------------------------
run_bayesian_model <- function(data, rois, sessions_keep, file_out) {

  # Prepare data 
  data <- data %>%
    mutate(
      Treatment = factor(Treatment, levels = c(0, 1), labels = c("Placebo", "Active")),
      Session   = factor(Session, levels = sessions_keep),
      Meal      = factor(Meal, levels = c("premeal", "postmeal")),
      Subject   = factor(Subject)
    ) %>%
    group_by(Treatment) %>%
    mutate(
      # Median imputation within treatment arm for single missing BL EDE-Q value
      BL_EDE_Q_Subscore_Global_Score =
        if_else(
          is.na(BL_EDE_Q_Subscore_Global_Score),
          median(BL_EDE_Q_Subscore_Global_Score, na.rm = TRUE),
          BL_EDE_Q_Subscore_Global_Score
        )
    ) %>%
    ungroup() %>%
    mutate(
      # Center/scale after imputation
      BL_EDE_Q_c = as.numeric(scale(BL_EDE_Q_Subscore_Global_Score, center = TRUE, scale = TRUE))
    )

  # Where to save brmsfit objects
  fits_dir <- file.path(dirname(file_out), "brmsfits")
  dir.create(fits_dir, showWarnings = FALSE, recursive = TRUE)
  session_tag <- paste(sessions_keep, collapse = "-")

  all_results <- data.frame()

  for (roi in rois) {

    # Build formula
    formula <- as.formula(paste0(roi, " ~ Treatment * Meal * Session + BL_EDE_Q_c + (1|Subject)"))

    # Explicit NA filtering (prevents silent row dropping)
    model_dat <- data %>%
      select(all_of(roi), Treatment, Meal, Session, BL_EDE_Q_c, Subject) %>%
      filter(complete.cases(.))

    # Fit model 
    model <- brm(
      formula = formula,
      data = model_dat,
      family = gaussian(),
      chains = 4,
      cores = 1,
      iter = 2000,
      warmup = 500,
      control = list(adapt_delta = 0.95),
      save_pars = save_pars(all = TRUE),
      backend = "rstan",
      silent = TRUE
    )

    # Save model object for later reporting stats (pd/BF/ICC/LOO/R2/EMMs)
    saveRDS(
      model,
      file = file.path(fits_dir, paste0("3factor_", session_tag, "_", roi, ".rds"))
    )

    # Extract fixed effects summary 
    fixed_effects <- as.data.frame(fixef(model))
    fixed_effects$Term <- rownames(fixed_effects)
    fixed_effects$ROI <- roi

    fixed_effects <- fixed_effects %>%
      rename(
        Estimate = Estimate,
        Est.Error = Est.Error,
        l95 = Q2.5,
        u95 = Q97.5
      ) %>%
      select(ROI, Term, Estimate, Est.Error, l95, u95)

    all_results <- rbind(all_results, fixed_effects)
  }

  dir.create(dirname(file_out), showWarnings = FALSE, recursive = TRUE)
  write.csv(all_results, file_out, row.names = FALSE)
  return(all_results)
}

# ------------------------------------------------------------
# 2-Factor meal-averaged helper (Treatment * Session)
#   - meal averaging: mean(pre, post) if both present
#     if post missing uses pre (mean over available)
# ------------------------------------------------------------
run_bayes_meal_averaged <- function(data_wide, rois, sessions_keep, file_out) {

  # Harmonize Treatment/Subject labels
  dat <- data_wide %>%
    mutate(
      Treatment = dplyr::case_when(
        Treatment %in% c("Placebo", "placebo") ~ "Placebo",
        Treatment %in% c("Active", "Treatment", "active", "treatment") ~ "Active",
        Treatment %in% c(0, "0") ~ "Placebo",
        Treatment %in% c(1, "1") ~ "Active",
        TRUE ~ NA_character_
      ),
      Treatment = factor(Treatment, levels = c("Placebo", "Active")),
      Subject   = factor(Subject)
    ) %>%
    filter(!is.na(Treatment), !is.na(Subject))

  # Baseline covariate: impute missing within arm, then z-score
  dat <- dat %>%
    mutate(
      BL_EDE_Q_Subscore_Global_Score = suppressWarnings(as.numeric(BL_EDE_Q_Subscore_Global_Score))
    ) %>%
    group_by(Treatment) %>%
    mutate(
      BL_EDE_Q_Subscore_Global_Score = if_else(
        is.na(BL_EDE_Q_Subscore_Global_Score),
        median(BL_EDE_Q_Subscore_Global_Score, na.rm = TRUE),
        BL_EDE_Q_Subscore_Global_Score
      )
    ) %>%
    ungroup() %>%
    mutate(
      BL_EDE_Q_c = as.numeric(scale(BL_EDE_Q_Subscore_Global_Score, center = TRUE, scale = TRUE))
    )

  # Where to save brmsfit objects
  fits_dir <- file.path(dirname(file_out), "brmsfits")
  dir.create(fits_dir, showWarnings = FALSE, recursive = TRUE)
  session_tag <- paste(sessions_keep, collapse = "-")

  all_results <- list()
  audit_list  <- list()

  for (roi in rois) {

    # Expected columns in wide data
    expected_cols <- as.vector(outer(
      sessions_keep, c("premeal", "postmeal"),
      function(s, m) paste0(s, "_", m, "_", roi)
    ))

    available_cols <- intersect(expected_cols, names(dat))
    missing_cols   <- setdiff(expected_cols, names(dat))

    if (length(available_cols) == 0) {
      warning("Skipping ROI '", roi, "' (2-factor) because no expected columns were found: ",
              paste(expected_cols, collapse = ", "))
      next
    }
    if (length(missing_cols) > 0) {
      warning("ROI '", roi, "' (2-factor): missing expected columns: ",
              paste(missing_cols, collapse = ", "))
    }

    # Long format for ROI across appropriate sessions & meals
    dat_long <- dat %>%
      select(Subject, Treatment, BL_EDE_Q_c, all_of(available_cols)) %>%
      pivot_longer(
        cols = all_of(available_cols),
        names_to   = c("Session", "Meal", "ROI"),
        names_pattern = "^(.*)_(premeal|postmeal)_(.*)$",
        values_to  = "beta",
        values_drop_na = FALSE
      ) %>%
      filter(ROI == roi) %>%
      select(-ROI) %>%
      mutate(
        Session = factor(Session, levels = sessions_keep),
        beta    = suppressWarnings(as.numeric(beta))
      )

    # Meal-average within Subject x Session:
    # - if both pre/post present -> mean
    # - if one present -> that one
    # - if both missing -> drop
    dat_avg <- dat_long %>%
      group_by(Subject, Treatment, BL_EDE_Q_c, Session) %>%
      summarise(
        n_nonmiss = sum(is.finite(beta)),
        beta_mean = ifelse(n_nonmiss > 0, mean(beta, na.rm = TRUE), NA_real_),
        .groups = "drop"
      ) %>%
      filter(!is.na(Session)) %>%
      filter(is.finite(beta_mean)) %>%
      mutate(Session = factor(Session, levels = sessions_keep))

    # Explicit NA filtering for model variables
    model_dat <- dat_avg %>%
      select(beta_mean, Treatment, Session, BL_EDE_Q_c, Subject) %>%
      filter(complete.cases(.))

    if (nrow(model_dat) == 0) {
      warning("Skipping ROI '", roi, "' (2-factor) because no complete cases after NA filtering.")
      next
    }

    # Fit model
    formula <- as.formula("beta_mean ~ Treatment * Session + BL_EDE_Q_c + (1 | Subject)")

    fit <- tryCatch(
      brm(
        formula = formula,
        data = model_dat,
        family = gaussian(),
        chains = 4,
        cores = 1,
        iter = 2000,
        warmup = 500,
        control = list(adapt_delta = 0.95),
        save_pars = save_pars(all = TRUE),
        backend = "rstan",
        silent = TRUE
      ),
      error = function(e) {
        warning("Failed for ROI ", roi, " (2-factor): ", e$message)
        return(NULL)
      }
    )
    if (is.null(fit)) next

    # Save model object
    saveRDS(
      fit,
      file = file.path(fits_dir, paste0("2factor_", session_tag, "_", roi, ".rds"))
    )

    # Extract fixed effects
    fe <- as.data.frame(fixef(fit))
    fe$Term <- rownames(fe)
    fe$ROI  <- roi

    fe <- fe %>%
      rename(
        Estimate  = Estimate,
        Est.Error = Est.Error,
        l95       = Q2.5,
        u95       = Q97.5
      ) %>%
      select(ROI, Term, Estimate, Est.Error, l95, u95)

    all_results[[roi]] <- fe
  }

  out <- bind_rows(all_results)
  dir.create(dirname(file_out), showWarnings = FALSE, recursive = TRUE)
  write.csv(out, file_out, row.names = FALSE)

  return(out)
}

```

#Dataset and ROIs
```{r}
rois <- c("Hypothalamus","Nacc","Caudate","Putamen","Hippocampus",
          "Amygdala","Insula","ACC","OFC","DLPFC")

data <- read.csv(paste0(data_PATH, "914_complete_data.csv"))
```

##3 FACTOR MODELS
#Model 1, BL-4wk
```{r}
run_bayesian_model(
  data = data,
  rois = rois,
  sessions_keep = c("ses-001", "ses-002"),
  file_out = file.path(results_PATH, "bayes_BL_4wk.csv")
)
```

#Model 2, BL-24wk
```{r}
run_bayesian_model(
  data = data,
  rois = rois,
  sessions_keep = c("ses-001", "ses-003"),
  file_out = file.path(results_PATH, "bayes_BL_24wk.csv")
)
```

#Model 3, 4wk-24wk
```{r}
run_bayesian_model(
  data = data,
  rois = rois,
  sessions_keep = c("ses-002", "ses-003"),
  file_out = file.path(results_PATH, "bayes_4wk_24wk.csv")
)
```

#Model 4, BL-4wk-24wk
```{r}
run_bayesian_model(
  data = data,
  rois = rois,
  sessions_keep = c("ses-001", "ses-002", "ses-003"),
  file_out = file.path(results_PATH, "bayes_BL_4wk_24wk.csv")
)
```

##2 FACTOR MODELS (meal averaged)
#Model 1: BL-4wk
```{r}
run_bayes_meal_averaged(
  data_wide = read.csv(paste0(data_PATH, "914_complete_data_wide.csv")),
  rois = rois, 
  sessions_keep = c("BL", "WK4"), 
  file_out = file.path(results_PATH, "bayes_meal_averaged_BL_WK4.csv")
  )
```


#Model 2: BL-24wk
```{r}
run_bayes_meal_averaged(
  data_wide = read.csv(paste0(data_PATH, "914_complete_data_wide.csv")),
  rois = rois, 
  sessions_keep = c("BL", "WK24"), 
  file_out = file.path(results_PATH, "bayes_meal_averaged_BL_WK24.csv")
  )
```


#Model 3: 4wk-24wk
```{r}
run_bayes_meal_averaged(
  data_wide = read.csv(paste0(data_PATH, "914_complete_data_wide.csv")),
  rois = rois, 
  sessions_keep = c("WK4", "WK24"), 
  file_out = file.path(results_PATH, "bayes_meal_averaged_WK4_WK24.csv")
  )
```


#Model 4: BL-4wk-24wk
```{r}
run_bayes_meal_averaged(
  data_wide = read.csv(paste0(data_PATH, "914_complete_data_wide.csv")),
  rois = rois, 
  sessions_keep = c("BL", "WK4", "WK24"), 
  file_out = file.path(results_PATH, "bayes_meal_averaged_BL_WK4_WK24.csv")
  )
```

#Compute model fit statistics
```{r}
suppressPackageStartupMessages({
  library(brms)
  library(dplyr)
  library(tidyr)
  library(posterior)
  library(loo)
  library(emmeans)
  library(stringr)
})

refit_models <- FALSE  # set TRUE if fresh environment and no previous brms objects

# Where to save reporting outputs
dir.create(results_PATH, showWarnings = FALSE, recursive = TRUE)

# -----------------------
# Helper: probability of direction for a parameter draw vector
# -----------------------
pd_from_draws <- function(x) {
  x <- as.numeric(x)
  x <- x[is.finite(x)]
  if (length(x) == 0) return(NA_real_)
  max(mean(x > 0), mean(x < 0))
}

# Helper: posterior prob sign
p_gt0 <- function(x) mean(as.numeric(x) > 0, na.rm = TRUE)
p_lt0 <- function(x) mean(as.numeric(x) < 0, na.rm = TRUE)

# -----------------------
# Helper: Extract draws and compute stats for selected fixed effects
# terms_pattern: regex pattern to match coefficient names, e.g.
#   "TreatmentActive:Session" or "TreatmentActive:Mealpostmeal:Session"
# -----------------------
coef_stats <- function(fit, model_label, roi_label, terms_pattern = NULL) {
  # posterior draws for population-level effects
  draws <- as_draws_df(fit)

  # population effects
  bcols <- grep("^b_", names(draws), value = TRUE)

  if (!is.null(terms_pattern)) {
    bcols <- bcols[str_detect(bcols, terms_pattern)]
  }

  if (length(bcols) == 0) {
    return(tibble(
      Model = model_label, ROI = roi_label, Term = NA_character_,
      pd = NA_real_, P_gt0 = NA_real_, P_lt0 = NA_real_,
      BF_10 = NA_real_
    ))
  }

  out <- lapply(bcols, function(col) {
    x <- draws[[col]]

    # Bayes factor for point-null (beta = 0):
    bf10 <- NA_real_
    h <- tryCatch(
      brms::hypothesis(fit, paste0(col, " = 0")),
      error = function(e) NULL
    )
    if (!is.null(h)) {
      # evidence ratio for the hypothesis vs its complement
      hs <- as.data.frame(h$hypothesis)
      if ("Evid.Ratio" %in% names(hs)) bf10 <- suppressWarnings(as.numeric(hs$Evid.Ratio[1]))
    }

    tibble(
      Model = model_label,
      ROI   = roi_label,
      Term  = sub("^b_", "", col),
      pd    = pd_from_draws(x),
      P_gt0 = p_gt0(x),
      P_lt0 = p_lt0(x),
      BF_10 = bf10
    )
  })

  bind_rows(out)
}

# -----------------------
# Helper: Random effects SD, residual SD, ICC
# -----------------------
re_stats <- function(fit, model_label, roi_label) {
  vc <- VarCorr(fit)

  # Extract SDs safely
  sd_subject <- NA_real_
  sd_resid   <- NA_real_

  # Random intercept SD for Subject
  # VarCorr structure varies
  sd_subject <- tryCatch(as.numeric(vc$Subject$sd[1]), error = function(e) NA_real_)

  # Residual SD ("sigma")
  sd_resid <- tryCatch(as.numeric(vc$residual__$sd[1]), error = function(e) NA_real_)

  icc <- if (is.finite(sd_subject) && is.finite(sd_resid)) {
    (sd_subject^2) / (sd_subject^2 + sd_resid^2)
  } else {
    NA_real_
  }

  tibble(
    Model = model_label,
    ROI   = roi_label,
    SD_Subject = sd_subject,
    SD_Residual = sd_resid,
    ICC = icc
  )
}

# -----------------------
# Helper: Bayesian R2 (distribution of R2 draws)
# -----------------------
r2_stats <- function(fit, model_label, roi_label) {
  r2 <- tryCatch(brms::bayes_R2(fit), error = function(e) NULL)
  if (is.null(r2)) {
    return(tibble(Model = model_label, ROI = roi_label, R2_med = NA_real_, R2_l95 = NA_real_, R2_u95 = NA_real_))
  }
  r2v <- as.numeric(r2[, "Estimate"])
  tibble(
    Model = model_label,
    ROI = roi_label,
    R2_med = median(r2v, na.rm = TRUE),
    R2_l95 = quantile(r2v, 0.025, na.rm = TRUE),
    R2_u95 = quantile(r2v, 0.975, na.rm = TRUE)
  )
}

# -----------------------
# Helper: LOO stats
# -----------------------
loo_stats <- function(fit, model_label, roi_label) {
  l <- tryCatch(loo::loo(fit), error = function(e) NULL)
  if (is.null(l)) {
    return(tibble(Model = model_label, ROI = roi_label, elpd_loo = NA_real_, looic = NA_real_, p_loo = NA_real_))
  }
  tibble(
    Model = model_label,
    ROI = roi_label,
    elpd_loo = l$estimates["elpd_loo", "Estimate"],
    looic    = l$estimates["looic",    "Estimate"],
    p_loo    = l$estimates["p_loo",    "Estimate"]
  )
}

# -----------------------
# Helper: EMMs + contrasts (3-factor models) and (2-factor meal-averaged)
# -----------------------
compute_emm <- TRUE

emm_3factor <- function(fit, model_label, roi_label) {
  # Requires predictors named Treatment, Meal, Session in the model
  em <- tryCatch(
    emmeans::emmeans(fit, ~ Treatment * Meal * Session),
    error = function(e) NULL
  )
  if (is.null(em)) return(NULL)

  # Key contrasts:
  # (a) Treatment difference within each Meal x Session
  c1 <- tryCatch(contrast(em, method = "revpairwise", by = c("Meal", "Session")), error = function(e) NULL)
  # (b) Pre vs Post within each Treatment x Session
  c2 <- tryCatch(contrast(em, method = "revpairwise", by = c("Treatment", "Session"), simple = "Meal"), error = function(e) NULL)

  out_em <- as.data.frame(em) %>% mutate(Model = model_label, ROI = roi_label, Type = "EMM")
  out_c1 <- if (!is.null(c1)) as.data.frame(c1) %>% mutate(Model = model_label, ROI = roi_label, Type = "Contrast_Treat_within_MealSession") else NULL
  out_c2 <- if (!is.null(c2)) as.data.frame(c2) %>% mutate(Model = model_label, ROI = roi_label, Type = "Contrast_Meal_within_TreatSession") else NULL

  bind_rows(out_em, out_c1, out_c2)
}

emm_2factor <- function(fit, model_label, roi_label) {
  em <- tryCatch(
    emmeans::emmeans(fit, ~ Treatment * Session),
    error = function(e) NULL
  )
  if (is.null(em)) return(NULL)

  # Key contrasts: Treatment diff at each Session, and Session changes within Treatment
  c1 <- tryCatch(contrast(em, method = "revpairwise", by = "Session"), error = function(e) NULL)
  c2 <- tryCatch(contrast(em, method = "revpairwise", by = "Treatment"), error = function(e) NULL)

  out_em <- as.data.frame(em) %>% mutate(Model = model_label, ROI = roi_label, Type = "EMM")
  out_c1 <- if (!is.null(c1)) as.data.frame(c1) %>% mutate(Model = model_label, ROI = roi_label, Type = "Contrast_Treat_within_Session") else NULL
  out_c2 <- if (!is.null(c2)) as.data.frame(c2) %>% mutate(Model = model_label, ROI = roi_label, Type = "Contrast_Session_within_Treatment") else NULL

  bind_rows(out_em, out_c1, out_c2)
}

# ===========================================================================
# Run to refit all models, in case returning to project with fresh environment
# ============================================================================
if (refit_models) {

  # 3-factor models (long format)
  fit3_bl_4wk      <- run_bayesian_model(data, rois, c("ses-001", "ses-002"), file.path(results_PATH, "bayes_BL_4wk.csv"))
  fit3_bl_24wk     <- run_bayesian_model(data, rois, c("ses-001", "ses-003"), file.path(results_PATH, "bayes_BL_24wk.csv"))
  fit3_4wk_24wk    <- run_bayesian_model(data, rois, c("ses-002", "ses-003"), file.path(results_PATH, "bayes_4wk_24wk.csv"))
  fit3_bl_4wk_24wk <- run_bayesian_model(data, rois, c("ses-001", "ses-002", "ses-003"), file.path(results_PATH, "bayes_BL_4wk_24wk.csv"))

  # 2-factor meal-averaged (wide format)
  data_wide <- read.csv(paste0(data_PATH, "914_complete_data_wide.csv"))
  fit2_bl_wk4      <- run_bayes_meal_averaged(data_wide, rois, c("BL", "WK4"),  file.path(results_PATH, "bayes_meal_averaged_BL_WK4.csv"))
  fit2_bl_wk24     <- run_bayes_meal_averaged(data_wide, rois, c("BL", "WK24"), file.path(results_PATH, "bayes_meal_averaged_BL_WK24.csv"))
  fit2_wk4_wk24    <- run_bayes_meal_averaged(data_wide, rois, c("WK4","WK24"), file.path(results_PATH, "bayes_meal_averaged_WK4_WK24.csv"))
  fit2_bl_wk4_wk24 <- run_bayes_meal_averaged(data_wide, rois, c("BL","WK4","WK24"), file.path(results_PATH, "bayes_meal_averaged_BL_WK4_WK24.csv"))

  stop()
}

fits_dir <- file.path(results_PATH, "brmsfits")
dir.create(fits_dir, showWarnings = FALSE, recursive = TRUE)
rds_files <- list.files(fits_dir, pattern = "\\.rds$", full.names = TRUE)

if (length(rds_files) == 0) {
  message("No .rds brmsfit files found in: ", fits_dir)
  message("To enable the reporting stats below, save each brms model during fitting via saveRDS(model, file=...).")
  message("See the small patch at the END of this chunk to add saveRDS into your existing loops.")
}

# Parse filenames into ModelType/Session/ROI (expects underscores)
# e.g., "3factor_BL-24wk_ACC.rds"
fits_index <- tibble(file = rds_files) %>%
  mutate(
    fname = basename(file),
    fname = str_replace(fname, "\\.rds$", ""),
    ModelType = str_split_fixed(fname, "_", 3)[,1],
    Session   = str_split_fixed(fname, "_", 3)[,2],
    ROI       = str_split_fixed(fname, "_", 3)[,3],
    ModelLabel = paste0(ModelType, "_", Session)
  )

# Load all fits into a named list (ModelLabel|ROI)
fits_loaded <- setNames(
  lapply(fits_index$file, readRDS),
  paste(fits_index$ModelLabel, fits_index$ROI, sep = "|")
)

# ============================================================
# Compute all reporting outputs
# ============================================================

all_coef_stats <- list()
all_re_stats   <- list()
all_r2_stats   <- list()
all_loo_stats  <- list()
all_emm        <- list()

for (i in seq_len(nrow(fits_index))) {
  key <- paste(fits_index$ModelLabel[i], fits_index$ROI[i], sep = "|")
  fit <- fits_loaded[[key]]

  model_label <- fits_index$ModelLabel[i]
  roi_label   <- fits_index$ROI[i]
  model_type  <- fits_index$ModelType[i]

  # Patterns:
  # - 2factor: focus on TreatmentActive:Session... (Group x Time)
  # - 3factor: focus on TreatmentActive:Mealpostmeal:Session... (Group x Meal x Time)
  if (model_type == "2factor") {
    pattern <- "b_TreatmentActive:Session"
    all_coef_stats[[key]] <- coef_stats(fit, model_label, roi_label, terms_pattern = pattern)
    if (compute_emm) all_emm[[key]] <- emm_2factor(fit, model_label, roi_label)
  } else if (model_type == "3factor") {
    pattern <- "b_TreatmentActive:Mealpostmeal:Session"
    all_coef_stats[[key]] <- coef_stats(fit, model_label, roi_label, terms_pattern = pattern)
    if (compute_emm) all_emm[[key]] <- emm_3factor(fit, model_label, roi_label)
  } else {
    # Compute for all fixed effects
    all_coef_stats[[key]] <- coef_stats(fit, model_label, roi_label, terms_pattern = NULL)
  }

  all_re_stats[[key]]  <- re_stats(fit, model_label, roi_label)
  all_r2_stats[[key]]  <- r2_stats(fit, model_label, roi_label)
  all_loo_stats[[key]] <- loo_stats(fit, model_label, roi_label)
}

coef_stats_df <- bind_rows(all_coef_stats)
re_stats_df   <- bind_rows(all_re_stats)
r2_stats_df   <- bind_rows(all_r2_stats)
loo_stats_df  <- bind_rows(all_loo_stats)
emm_df        <- bind_rows(all_emm)

# Save outputs
write.csv(coef_stats_df, file.path(results_PATH, "bayes_reporting_coef_pd_bf.csv"), row.names = FALSE)
write.csv(re_stats_df,   file.path(results_PATH, "bayes_reporting_random_effects_icc.csv"), row.names = FALSE)
write.csv(r2_stats_df,   file.path(results_PATH, "bayes_reporting_bayesR2.csv"), row.names = FALSE)
write.csv(loo_stats_df,  file.path(results_PATH, "bayes_reporting_LOO.csv"), row.names = FALSE)
if (nrow(emm_df) > 0) {
  write.csv(emm_df, file.path(results_PATH, "bayes_reporting_EMMs_and_contrasts.csv"), row.names = FALSE)
}
```

#Rerun LOO with moment-matching to overcome pareto_k warnings 
```{r}
suppressPackageStartupMessages({
  library(brms)
  library(loo)
  library(dplyr)
  library(tibble)
  library(stringr)
})

fits_dir <- file.path(results_PATH, "brmsfits")
rds_files <- list.files(fits_dir, pattern = "\\.rds$", full.names = TRUE)

if (length(rds_files) == 0) {
  stop("No .rds files found in: ", fits_dir, "\nDid you run the patched model functions with saveRDS()?")
}

# Parse filenames like:
#   3factor_ses-001-ses-003_ACC.rds
#   2factor_BL-WK24_Nacc.rds
fits_index <- tibble(file = rds_files) %>%
  mutate(
    fname = basename(file) %>% str_replace("\\.rds$", ""),
    ModelType = str_match(fname, "^(2factor|3factor)")[,2],
    Session   = str_match(fname, "^(?:2factor|3factor)_(.*)_(.*)$")[,2],
    ROI       = str_match(fname, "^(?:2factor|3factor)_(.*)_(.*)$")[,3],
    ModelLabel = paste0(ModelType, "_", Session)
  )

# Load fits
fits_loaded <- setNames(lapply(fits_index$file, readRDS), paste(fits_index$ModelLabel, fits_index$ROI, sep = "|"))

# Compute LOO with moment matching
loo_out <- vector("list", length(fits_loaded))
names(loo_out) <- names(fits_loaded)

for (nm in names(fits_loaded)) {
  fit <- fits_loaded[[nm]]

  l <- tryCatch(
    loo::loo(fit, moment_match = TRUE),
    error = function(e) {
      message("LOO failed for ", nm, ": ", e$message)
      return(NULL)
    }
  )

  if (is.null(l)) {
    loo_out[[nm]] <- tibble(
      key = nm, elpd_loo = NA_real_, looic = NA_real_, p_loo = NA_real_,
      n_pareto_k_gt_0.7 = NA_integer_, max_pareto_k = NA_real_
    )
  } else {
    k <- l$diagnostics$pareto_k
    loo_out[[nm]] <- tibble(
      key = nm,
      elpd_loo = l$estimates["elpd_loo", "Estimate"],
      looic    = l$estimates["looic",    "Estimate"],
      p_loo    = l$estimates["p_loo",    "Estimate"],
      n_pareto_k_gt_0.7 = sum(k > 0.7, na.rm = TRUE),
      max_pareto_k      = max(k, na.rm = TRUE)
    )
  }
}

loo_df <- bind_rows(loo_out) %>%
  separate(key, into = c("ModelLabel", "ROI"), sep = "\\|", remove = TRUE) %>%
  mutate(
    ModelType = str_match(ModelLabel, "^(2factor|3factor)")[,2],
    Session   = str_replace(ModelLabel, "^(2factor|3factor)_", "")
  ) %>%
  select(ModelType, Session, ROI, elpd_loo, looic, p_loo, n_pareto_k_gt_0.7, max_pareto_k) %>%
  arrange(ModelType, Session, ROI)

out_path <- file.path(results_PATH, "bayes_reporting_LOO_momentmatch.csv")
write.csv(loo_df, out_path, row.names = FALSE)

message("Saved LOO (moment_match=TRUE) to: ", out_path)
```

#Selective reloo for max_pareto_k>0.7 (4 models)
```{r}
# ============================================================
# Selective reloo for four models with pareto_k>0.7
# - Uses known ModelType / Session / ROI combinations
# - Runs loo(..., moment_match = TRUE, reloo = TRUE)
# - Saves: bayes_reporting_LOO_reloo_selected.csv
# ============================================================

suppressPackageStartupMessages({
  library(brms)
  library(loo)
  library(dplyr)
  library(tibble)
  library(stringr)
})

# ---- Define the four flagged models explicitly ----
flagged_models <- tribble(
  ~ModelType, ~Session,                      ~ROI,
  "2factor",  "BL-WK4",                      "OFC",
  "3factor",  "ses-001-ses-002-ses-003",     "OFC",
  "3factor",  "ses-001-ses-002-ses-003",     "Insula",
  "2factor",  "WK4-WK24",                    "Insula"
) %>%
  mutate(
    ModelLabel = paste0(ModelType, "_", Session),
    key = paste(ModelLabel, ROI, sep = "|")
  )

print(flagged_models)

# ---- Load saved brmsfit objects ----
fits_dir <- file.path(results_PATH, "brmsfits")
rds_files <- list.files(fits_dir, pattern = "\\.rds$", full.names = TRUE)


fits_index <- tibble(file = rds_files) %>%
  mutate(
    fname = basename(file) %>% str_replace("\\.rds$", ""),
    ModelType = str_match(fname, "^(2factor|3factor)")[,2],
    Session   = str_match(fname, "^(?:2factor|3factor)_(.*)_(.*)$")[,2],
    ROI       = str_match(fname, "^(?:2factor|3factor)_(.*)_(.*)$")[,3],
    ModelLabel = paste0(ModelType, "_", Session),
    key = paste(ModelLabel, ROI, sep = "|")
  )

fits_loaded <- setNames(lapply(fits_index$file, readRDS), fits_index$key)

# ---- Run reloo only for flagged models ----
reloo_rows <- list()

for (i in seq_len(nrow(flagged_models))) {

  key <- flagged_models$key[i]
  fit <- fits_loaded[[key]]

  if (is.null(fit)) {
    warning("Could not find fit for key: ", key)
    reloo_rows[[key]] <- tibble(
      ModelType = flagged_models$ModelType[i],
      Session   = flagged_models$Session[i],
      ROI       = flagged_models$ROI[i],
      method    = "fit_not_found",
      elpd_loo  = NA_real_,
      looic     = NA_real_,
      p_loo     = NA_real_,
      n_pareto_k_gt_0.7 = NA_integer_,
      max_pareto_k      = NA_real_
    )
    next
  }

  message("Running reloo for: ", key)

  l_reloo <- tryCatch(
    loo::loo(fit, moment_match = TRUE, reloo = TRUE),
    error = function(e) {
      message("reloo failed for ", key, ": ", e$message)
      return(NULL)
    }
  )

  if (is.null(l_reloo)) {
    reloo_rows[[key]] <- tibble(
      ModelType = flagged_models$ModelType[i],
      Session   = flagged_models$Session[i],
      ROI       = flagged_models$ROI[i],
      method    = "reloo_failed",
      elpd_loo  = NA_real_,
      looic     = NA_real_,
      p_loo     = NA_real_,
      n_pareto_k_gt_0.7 = NA_integer_,
      max_pareto_k      = NA_real_
    )
  } else {
    k <- l_reloo$diagnostics$pareto_k
    reloo_rows[[key]] <- tibble(
      ModelType = flagged_models$ModelType[i],
      Session   = flagged_models$Session[i],
      ROI       = flagged_models$ROI[i],
      method    = "moment_match + reloo",
      elpd_loo  = l_reloo$estimates["elpd_loo", "Estimate"],
      looic     = l_reloo$estimates["looic",    "Estimate"],
      p_loo     = l_reloo$estimates["p_loo",    "Estimate"],
      n_pareto_k_gt_0.7 = sum(k > 0.7, na.rm = TRUE),
      max_pareto_k      = max(k, na.rm = TRUE)
    )
  }
}

reloo_df <- bind_rows(reloo_rows)

# ---- Save output ----
out_path <- file.path(results_PATH, "bayes_reporting_LOO_reloo_selected.csv")
write.csv(reloo_df, out_path, row.names = FALSE)

message("Selective reloo results saved to: ", out_path)

```

#Final reloo for last two models with failed fits from above
```{r}
library(future)
future::plan(future::sequential)
options(future.globals.maxSize = Inf)

suppressPackageStartupMessages({
  library(brms)
  library(loo)
  library(dplyr)
  library(tibble)
  library(stringr)
  library(future)
})

future::plan(future::sequential)
options(future.globals.maxSize = Inf)

# Keys that failed previously
failed_keys <- c(
  "2factor_BL-WK4|OFC",
  "2factor_WK4-WK24|Insula"
)

# Load fits
fits_dir <- file.path(results_PATH, "brmsfits")
rds_files <- list.files(fits_dir, pattern="\\.rds$", full.names=TRUE)

fits_index <- tibble(file = rds_files) %>%
  mutate(
    fname = basename(file) %>% str_replace("\\.rds$", ""),
    ModelType = str_match(fname, "^(2factor|3factor)")[,2],
    Session   = str_match(fname, "^(?:2factor|3factor)_(.*)_(.*)$")[,2],
    ROI       = str_match(fname, "^(?:2factor|3factor)_(.*)_(.*)$")[,3],
    ModelLabel = paste0(ModelType, "_", Session),
    key = paste(ModelLabel, ROI, sep="|")
  )

fits_loaded <- setNames(lapply(fits_index$file, readRDS), fits_index$key)

reloo_fix_rows <- list()

for (key in failed_keys) {
  fit <- fits_loaded[[key]]
  if (is.null(fit)) {
    warning("Fit not found for: ", key)
    next
  }

  message("Retrying reloo sequentially for: ", key)

  l_reloo <- tryCatch(
    loo::loo(fit, moment_match = TRUE, reloo = TRUE),
    error = function(e) {
      message("Still failed for ", key, ": ", e$message)
      return(NULL)
    }
  )

  if (!is.null(l_reloo)) {
    k <- l_reloo$diagnostics$pareto_k
    parts <- str_split(key, "\\|", simplify = TRUE)
    ModelLabel <- parts[1]
    ROI <- parts[2]
    ModelType <- str_match(ModelLabel, "^(2factor|3factor)")[,2]
    Session <- str_replace(ModelLabel, "^(2factor|3factor)_", "")

    reloo_fix_rows[[key]] <- tibble(
      ModelType = ModelType,
      Session   = Session,
      ROI       = ROI,
      method    = "moment_match + reloo",
      elpd_loo  = l_reloo$estimates["elpd_loo", "Estimate"],
      looic     = l_reloo$estimates["looic",    "Estimate"],
      p_loo     = l_reloo$estimates["p_loo",    "Estimate"],
      n_pareto_k_gt_0.7 = sum(k > 0.7, na.rm = TRUE),
      max_pareto_k      = max(k, na.rm = TRUE)
    )
  }
}

reloo_fix_df <- bind_rows(reloo_fix_rows)

# Save just the fixes
out_path_fix <- file.path(results_PATH, "bayes_reporting_LOO_reloo_fixes.csv")
write.csv(reloo_fix_df, out_path_fix, row.names = FALSE)
message("Saved reloo fixes to: ", out_path_fix)

```
#Merge reloo csvs
```{r}
# ============================================================
# MERGE moment_match LOO + ALL reloo corrections into one table
# Output: bayes_reporting_LOO_final.csv
# ============================================================

suppressPackageStartupMessages({
  library(dplyr)
})

loo_mm <- read.csv(file.path(results_PATH, "bayes_reporting_LOO_momentmatch.csv"))

loo_reloo_selected <- read.csv(file.path(results_PATH, "bayes_reporting_LOO_reloo_selected.csv"))
loo_reloo_fixes    <- read.csv(file.path(results_PATH, "bayes_reporting_LOO_reloo_fixes.csv"))

# Keep only the successful reloo rows
reloo_all <- bind_rows(loo_reloo_selected, loo_reloo_fixes) %>%
  filter(method == "moment_match + reloo") %>%
  select(ModelType, Session, ROI, elpd_loo, looic, p_loo, n_pareto_k_gt_0.7, max_pareto_k)

# Update the moment-matched table with reloo-corrected rows
loo_final <- loo_mm %>%
  rows_update(reloo_all, by = c("ModelType", "Session", "ROI")) %>%
  arrange(ModelType, Session, ROI)

out_final <- file.path(results_PATH, "bayes_reporting_LOO_final.csv")
write.csv(loo_final, out_final, row.names = FALSE)

message("Saved final LOO table to: ", out_final)

```

#Visualize group x meal interaction 
```{r}
library(ggplot2)
library(dplyr)

# Load results from three-factor model
bayes_results <- read.csv(file.path(results_PATH, "bayes_4wk_24wk.csv"))

# Filter only Treatment × Meal interaction terms
plot_data <- bayes_results %>%
  filter(Term == "TreatmentActive:Mealpostmeal") %>%
  arrange(Estimate)

# Forest plot
ggplot(plot_data, aes(x = Estimate, y = ROI)) +
  geom_point(size = 3, color = "aquamarine3") +
  geom_errorbarh(aes(xmin = l95, xmax = u95), height = 0.2, color = "aquamarine3") +
  geom_vline(xintercept = 0, linetype = "dashed", color = "gray40") +
  labs(
    title = "4wk-24wk Treatment × Meal Interaction",
    x = "Effect Estimate (Posterior Mean)",
    y = "ROI"
  ) +
  theme_minimal(base_size = 14) + 
  theme() + 
  theme(plot.title = element_text(hjust = 0.5))


```

#Visualize group x session results 
```{r}
library(ggplot2)
library(dplyr)

# Load 2-factor results
bayes_results <- read.csv(file.path(results_PATH, "bayes_WK4_WK24.csv"))

# Filter only interaction terms of interest
plot_data <- bayes_results %>%
  filter(grepl("TreatmentActive:SessionsesM003", Term)) %>%
  arrange(Estimate)

# Forest plot
ggplot(plot_data, aes(x = Estimate, y = ROI)) +
  geom_point(size = 3, color = "aquamarine3") +
  geom_errorbarh(aes(xmin = l95, xmax = u95), height = 0.2, color = "aquamarine3") +
  geom_vline(xintercept = 0, linetype = "dashed", color = "gray40") +
  labs(
    title = "4wk-24wk Treatment × Session Interaction",
    x = "Effect Estimate (Posterior Mean)",
    y = "ROI"
  ) +
  theme_minimal(base_size = 14) + 
  theme(plot.title = element_text(hjust = 0.5))

```


#Plot betas for meaningful ROIs 
```{r}
library(dplyr)
library(ggplot2)
library(stringr)
library(tidyr)

# Load and prepare data 
fmri_long <- read.csv(file.path(data_PATH, "914_complete_data.csv"))

regions <- c("Caudate", "Nacc", "DLPFC")

fmri_long <- fmri_long %>%
  mutate(
    Treatment = factor(Treatment, levels = c(0, 1), labels = c("Placebo", "Treatment")),
    Visit = recode(Session,
                   "ses-001" = "BL",
                   "ses-002" = "WK4",
                   "ses-003" = "WK24"),
    Visit = factor(Visit, levels = c("BL", "WK4", "WK24")),
    Meal  = factor(Meal, levels = c("premeal", "postmeal"))
  )

# Compute meal-averaged betas for selected ROIs
avg_df <- fmri_long %>%
  pivot_longer(cols = all_of(regions), names_to = "Region", values_to = "Beta") %>%
  group_by(Subject, Treatment, Visit, Region) %>%
  summarise(Beta = mean(Beta, na.rm = TRUE), .groups = "drop")

# --- Plot: three panels for Caudate, Nacc, DLPFC ---
p <- ggplot(avg_df, aes(x = Visit, y = Beta, color = Treatment, group = Treatment)) +
  stat_summary(fun = mean, geom = "line", linewidth = 1, na.rm = TRUE) +
  stat_summary(fun = mean, geom = "point", size = 3, na.rm = TRUE) +
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.12, na.rm = TRUE) +
  facet_wrap(~ Region, nrow = 1) +
  scale_color_manual(values = c("Treatment" = "#E31A1C", "Placebo" = "#1f77b4")) +
  labs(
    title = "ROI Activation Across Weeks",
    x = "Visit",
    y = "Meal-Averaged Betas (Mean ± SE)",
    color = "Group"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
    legend.position = "top",
    panel.spacing.x = unit(1.2, "lines")
  )

# Save figure
out_file <- file.path(figures_PATH, "roi_activation_across_weeks.png")
ggsave(out_file, p, width = 12, height = 4, dpi = 300)
message("Saved: ", out_file)

# Print plot
p
```
